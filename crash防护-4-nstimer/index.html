<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/avatar@2x.png?v=2.3.0" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/avatar@3x.png?v=2.3.0" type="image/png" sizes="32x32"><meta name="description" content="关键词：NSTimer、Runloop、循环引用、NSProxy">
<meta property="og:type" content="article">
<meta property="og:title" content="Crash防护(4)-NSTimer">
<meta property="og:url" content="https://jack110530.github.io/crash%E9%98%B2%E6%8A%A4-4-nstimer/index.html">
<meta property="og:site_name" content="jack110530的博客">
<meta property="og:description" content="关键词：NSTimer、Runloop、循环引用、NSProxy">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jack110530.github.io/crash%E9%98%B2%E6%8A%A4-4-nstimer/%E9%87%8D%E6%8B%BEiOS.jpg">
<meta property="article:published_time" content="2020-10-27T05:44:15.000Z">
<meta property="article:modified_time" content="2020-10-28T03:07:35.595Z">
<meta property="article:author" content="jack110530">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jack110530.github.io/crash%E9%98%B2%E6%8A%A4-4-nstimer/%E9%87%8D%E6%8B%BEiOS.jpg"><title>Crash防护(4)-NSTimer | jack110530的博客</title><link ref="canonical" href="https://jack110530.github.io/crash%E9%98%B2%E6%8A%A4-4-nstimer/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.3.0"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":"ture"},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: true,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="jack110530的博客" type="application/atom+xml">
</head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">jack110530的博客</div><div class="header-banner-info__subtitle">路漫漫其修远兮，吾将上下而求索。</div></div><div class="header-banner-arrow"><div class="header-banner-arrow__icon"><i class="fas fa-angle-down"></i></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">Crash防护(4)-NSTimer</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2020-10-27</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2020-10-28</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">1.7k</span></span></div></header><div class="post-body"><img src="/crash%E9%98%B2%E6%8A%A4-4-nstimer/%E9%87%8D%E6%8B%BEiOS.jpg" class="">
<br>

<blockquote>
<p>关键词：NSTimer、Runloop、循环引用、NSProxy</p>
</blockquote>
<a id="more"></a>

<p>Crash防护系列文章:<br></p>
<ul>
<li><a href="https://jack110530.github.io/crash%E9%98%B2%E6%8A%A4-1-unrecognized-selector/">Crash防护(1)-Unrecognized Selector</a></li>
<li><a href="https://jack110530.github.io/crash%E9%98%B2%E6%8A%A4-2-kvo/">Crash防护(2)-KVO</a></li>
<li><a href="https://jack110530.github.io/crash%E9%98%B2%E6%8A%A4-3-kvc/">Crash防护(3)-KVC</a></li>
<li><a href="https://jack110530.github.io/crash%E9%98%B2%E6%8A%A4-4-nstimer/">Crash防护(4)-NSTimer</a></li>
</ul>

        <h3 id="前言"   >
          <a href="#前言" class="heading-link"><i class="fas fa-link"></i></a>前言</h3>
      <ol>
<li>开发中又遇到NSTimer相关的问题吗，是怎么解决的？</li>
<li>NSTimer循环引用方案</li>
</ol>

        <h3 id="NSTimer-Crash-的产生原因"   >
          <a href="#NSTimer-Crash-的产生原因" class="heading-link"><i class="fas fa-link"></i></a>NSTimer Crash 的产生原因</h3>
      <p>在程序开发过程中，大家会经常使用定时任务，但使用NSTimer的 scheduledTimerWithTimeInterval:target:selector:userInfo:repeats:接口做重复性的定时任务时存在一个问题：NSTimer会强引用target实例，所以需要在合适的时机invalidate定时器，否则就会由于定时器timer强引用target的关系导致target不能被释放，造成内存泄露，甚至在定时任务触发时导致crash。crash的展现形式和具体的target执行的selector有关。<br></p>
<p>与此同时，如果NSTimer是无限重复的执行一个任务的话，也有可能导致target的selector一直被重复调用且处于无效状态，对app的CPU，内存等性能方面均是没有必要的浪费。<br></p>
<p><strong>代码示例</strong>：<br></p>
<figure class="highlight objc"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;TimerCrashTestVC.h&quot;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TimerCrashTestVC</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSTimer</span> *timer;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TimerCrashTestVC</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="keyword">self</span>.timer = [<span class="built_in">NSTimer</span> timerWithTimeInterval:<span class="number">1</span> target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(timerEvent) userInfo:<span class="literal">nil</span> repeats:<span class="literal">YES</span>];</span><br><span class="line">    [[<span class="built_in">NSRunLoop</span> currentRunLoop] addTimer:<span class="keyword">self</span>.timer forMode:<span class="built_in">NSRunLoopCommonModes</span>];</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)timerEvent&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;定时器事件&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%s&quot;</span>, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></div></figure>
<p>在ViewController中，点击按钮push到TimerCrashTestVC。<br></p>
<figure class="highlight objc"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TimerCrashTestVC *vc = [[TimerCrashTestVC alloc]init];</span><br><span class="line">[<span class="keyword">self</span>.navigationController pushViewController:vc animated:<span class="literal">YES</span>];</span><br></pre></td></tr></table></div></figure>
<p>控制台打印定时器事件:<br></p>
<figure class="highlight objc"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span><span class="number">-10</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">16</span>:<span class="number">37.877364</span>+<span class="number">0800</span> TestDemo[<span class="number">39003</span>:<span class="number">883014</span>] 定时器事件</span><br><span class="line"><span class="number">2020</span><span class="number">-10</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">16</span>:<span class="number">38.876337</span>+<span class="number">0800</span> TestDemo[<span class="number">39003</span>:<span class="number">883014</span>] 定时器事件</span><br><span class="line"><span class="number">2020</span><span class="number">-10</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">16</span>:<span class="number">39.877408</span>+<span class="number">0800</span> TestDemo[<span class="number">39003</span>:<span class="number">883014</span>] 定时器事件</span><br><span class="line">...</span><br></pre></td></tr></table></div></figure>
<p>此时，若pop，按我们想象的来说，TimerCrashTestVC应该dealloc 并且NSTimer也应该停止。<br><br>但是，当我们pop时，事实却与我们想象的不一样，打印如下：<br></p>
<figure class="highlight objc"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span><span class="number">-10</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">16</span>:<span class="number">40.877086</span>+<span class="number">0800</span> TestDemo[<span class="number">39003</span>:<span class="number">883014</span>] 定时器事件</span><br><span class="line"><span class="number">2020</span><span class="number">-10</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">16</span>:<span class="number">41.877532</span>+<span class="number">0800</span> TestDemo[<span class="number">39003</span>:<span class="number">883014</span>] 定时器事件</span><br><span class="line"><span class="number">2020</span><span class="number">-10</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">16</span>:<span class="number">42.877496</span>+<span class="number">0800</span> TestDemo[<span class="number">39003</span>:<span class="number">883014</span>] 定时器事件</span><br><span class="line">...</span><br></pre></td></tr></table></div></figure>
<p>TimerCrashTestVC并没有dealloc，并且NSTimer也没有停止！！！<br></p>
<p>有人说，需要在dealloc中将NSTImer invalidate。比如：<br></p>
<figure class="highlight objc"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%s&quot;</span>, __func__);</span><br><span class="line">    [<span class="keyword">self</span>.timer invalidate];</span><br><span class="line">    <span class="keyword">self</span>.timer = <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>不幸的是，dealloc方法将永远不会被调用。因为timer的引用，TimerCrashTestVC对象的引用计数永远不会降到0，dealloc方法也就不会被调用，timer也一直在执行事件。<br></p>
<p>其实，在实际开发过程中很容易出现这种错误。<br></p>
<p>所以，很有必要设计出一种方案，可以有效的防护NSTimer的滥用问题。</p>

        <h3 id="NSTimer-Crash-防护方案"   >
          <a href="#NSTimer-Crash-防护方案" class="heading-link"><i class="fas fa-link"></i></a>NSTimer Crash 防护方案</h3>
      <p>苹果官方文档中：<br></p>
<blockquote>
<p>This method is the only way to remove a timer from an NSRunLoop object. The NSRunLoop object removes its strong reference to the timer, either just before the invalidate method returns or at some later point.<br>If it was configured with target and user info objects, the receiver removes its strong references to those objects as well.<br>You must send this message from the thread on which the timer was installed. If you send this message from another thread, the input source associated with the timer may not be removed from its run loop, which could prevent the thread from exiting properly.</p>
</blockquote>
<p>可以看到，当一个timer被schedule的时候，timer会持有target对象，NSRunLoop对象会持有timer。当invalidate被调用时，NSRunLoop对象会释放对timer的持有，timer会释放对target的持有。除此之外，我们没有途径可以释放timer对target的持有。所以解决内存泄露就必须撤销timer，若不撤销，target对象将永远无法释放。<br></p>
<p>上面的分析可见，NSTimer所产生的问题的主要原因是因为其没有再一个合适的时机invalidate，同时还有NSTimer对target的强引用导致的内存泄漏问题。<br></p>
<p>那么解决NSTimer的问题的关键点在于以下两点：<br></p>
<ol>
<li>STimer对其target是否可以不强引用；</li>
<li>是否找到一个合适的时机，在确定NSTimer已经失效的情况下，让NSTimer自动invalidate；</li>
</ol>
<p>针对第一点，可以使用NSProxy消息转发实现。<br><br>在NSTimer和target之间加入一层proxy，proxy主要做为一个桥接层，负责NSTimer和target之间的通信。<br><br>让NSProxy作为NSTimer的target，NSTimer强引用着proxy，同时proxy弱引用真正的target，并把所有的消息转发到真正的target上。这样就解决了循环引用的问题了。<br></p>
<p>针对第二点，也可以使用中间层，在执行定时器的方法selector前判断NSTimer是否已经失效。<br></p>
<p>结合第一点和第二点总结，有如下代码：<br><br>首先，子类化一个NSProxy用于做消息转发。<br></p>
<figure class="highlight objc"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SFProxy</span> : <span class="title">NSProxy</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="built_in">NSObject</span> *target;</span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithTarget:(<span class="keyword">id</span>)target;</span><br><span class="line">+ (<span class="keyword">instancetype</span>)proxyWithTarget:(<span class="keyword">id</span>)target;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// .m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">SFProxy</span></span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithTarget:(<span class="keyword">id</span>)target &#123;</span><br><span class="line">    _target = target;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line">+ (<span class="keyword">instancetype</span>)proxyWithTarget:(<span class="keyword">id</span>)target &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc] initWithTarget:target];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消息转发</span></span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.target &amp;&amp; [<span class="keyword">self</span>.target respondsToSelector:aSelector]) &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span>.target methodSignatureForSelector:aSelector];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> methodSignatureForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation&#123;</span><br><span class="line">    SEL aSelector = [anInvocation selector];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.target &amp;&amp; [<span class="keyword">self</span>.target respondsToSelector:aSelector]) &#123;</span><br><span class="line">        [anInvocation invokeWithTarget:<span class="keyword">self</span>.target];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">super</span> forwardInvocation:anInvocation];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></div></figure>
<p>然后，再子类化SFProxy，用于接收aTarget的aSelector，在执行前判断timer是否应该invalidate。<br></p>
<figure class="highlight objc"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SFTimerProxy</span> : <span class="title">SFProxy</span></span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithTarget:(<span class="keyword">id</span>)target aSelector:(SEL)aSelector;</span><br><span class="line">+ (<span class="keyword">instancetype</span>)proxyWithTarget:(<span class="keyword">id</span>)target aSelector:(SEL)aSelector;</span><br><span class="line">- (<span class="keyword">void</span>)fireProxyTimer:(<span class="built_in">NSTimer</span> *)timer;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// .m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">SFTimerProxy</span></span></span><br><span class="line">&#123;</span><br><span class="line">    SEL _aSelector;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithTarget:(<span class="keyword">id</span>)target aSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> initWithTarget:target];</span><br><span class="line">    _aSelector = aSelector;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line">+ (<span class="keyword">instancetype</span>)proxyWithTarget:(<span class="keyword">id</span>)target aSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc] initWithTarget:target aSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)fireProxyTimer:(<span class="built_in">NSTimer</span> *)timer &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.target) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span>.target respondsToSelector:_aSelector]) &#123;</span><br><span class="line">            [<span class="keyword">self</span>.target performSelector:_aSelector withObject:timer];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        [timer invalidate];</span><br><span class="line">        timer = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span><span class="class"><span class="keyword">@implementation</span> <span class="title">SFTimerProxy</span></span></span><br><span class="line">&#123;</span><br><span class="line">    SEL _aSelector;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithTarget:(<span class="keyword">id</span>)target aSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> initWithTarget:target];</span><br><span class="line">    _aSelector = aSelector;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line">+ (<span class="keyword">instancetype</span>)proxyWithTarget:(<span class="keyword">id</span>)target aSelector:(SEL)aSelector &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc] initWithTarget:target aSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)fireProxyTimer:(<span class="built_in">NSTimer</span> *)timer &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.target) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span>.target respondsToSelector:_aSelector]) &#123;</span><br><span class="line">            [<span class="keyword">self</span>.target performSelector:_aSelector withObject:timer];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        [timer invalidate];</span><br><span class="line">        timer = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></div></figure>
<p>第三步，新建一个分类NSTimer+TimerCrash。<br></p>
<figure class="highlight objc"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;NSTimer+TimerCrash.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;NSObject+MethodSwizzling.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;SFCrachInspector.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;SFTimerProxy.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSTimer</span> (<span class="title">TimerCrash</span>)</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 交换timerWithTimeInterval:target:selector:userInfo:repeats:方法</span></span><br><span class="line">        [<span class="built_in">NSObject</span> sf_swizzlingClassMethod:<span class="keyword">@selector</span>(timerWithTimeInterval:target:selector:userInfo:repeats:) swizzledMethod:<span class="keyword">@selector</span>(sf_timerWithTimeInterval:target:selector:userInfo:repeats:) withClass:[<span class="built_in">NSTimer</span> <span class="keyword">class</span>]];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 交换scheduledTimerWithTimeInterval:target:selector:userInfo:repeats:方法</span></span><br><span class="line">        [<span class="built_in">NSObject</span> sf_swizzlingClassMethod:<span class="keyword">@selector</span>(scheduledTimerWithTimeInterval:target:selector:userInfo:repeats:) swizzledMethod:<span class="keyword">@selector</span>(sf_scheduledTimerWithTimeInterval:target:selector:userInfo:repeats:) withClass:[<span class="built_in">NSTimer</span> <span class="keyword">class</span>]];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSTimer</span> *)sf_timerWithTimeInterval:(<span class="built_in">NSTimeInterval</span>)ti target:(<span class="keyword">id</span>)aTarget selector:(SEL)aSelector userInfo:(<span class="keyword">nullable</span> <span class="keyword">id</span>)userInfo repeats:(<span class="built_in">BOOL</span>)yesOrNo &#123;</span><br><span class="line">    SFTimerProxy *proxy = [SFTimerProxy proxyWithTarget:aTarget aSelector:aSelector];</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> sf_timerWithTimeInterval:ti target:proxy selector:<span class="keyword">@selector</span>(fireProxyTimer:) userInfo:userInfo repeats:yesOrNo];</span><br><span class="line">&#125;</span><br><span class="line">+ (<span class="built_in">NSTimer</span> *)sf_scheduledTimerWithTimeInterval:(<span class="built_in">NSTimeInterval</span>)ti target:(<span class="keyword">id</span>)aTarget selector:(SEL)aSelector userInfo:(<span class="keyword">nullable</span> <span class="keyword">id</span>)userInfo repeats:(<span class="built_in">BOOL</span>)yesOrNo &#123;</span><br><span class="line">    SFTimerProxy *proxy = [SFTimerProxy proxyWithTarget:aTarget aSelector:aSelector];</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> sf_scheduledTimerWithTimeInterval:ti target:proxy selector:<span class="keyword">@selector</span>(fireProxyTimer:) userInfo:userInfo repeats:yesOrNo];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></div></figure>

<p>至此，NSTimer的循环引用问题和NSTimer的invalidate时机问题就解决了。<br></p>
<p>重新运行后，push后pop，打印如下：<br></p>
<figure class="highlight objc"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span><span class="number">-10</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">41</span>:<span class="number">18.160033</span>+<span class="number">0800</span> TestDemo[<span class="number">39207</span>:<span class="number">898748</span>] 定时器事件</span><br><span class="line"><span class="number">2020</span><span class="number">-10</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">41</span>:<span class="number">19.160044</span>+<span class="number">0800</span> TestDemo[<span class="number">39207</span>:<span class="number">898748</span>] 定时器事件</span><br><span class="line"><span class="number">2020</span><span class="number">-10</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">41</span>:<span class="number">20.160049</span>+<span class="number">0800</span> TestDemo[<span class="number">39207</span>:<span class="number">898748</span>] 定时器事件</span><br><span class="line"><span class="number">2020</span><span class="number">-10</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">41</span>:<span class="number">21.100760</span>+<span class="number">0800</span> TestDemo[<span class="number">39207</span>:<span class="number">898748</span>] -[TimerCrashTestVC dealloc]</span><br></pre></td></tr></table></div></figure>
<p>此时，我们不需要在dealloc中写NSTImer invalidate方法，TimerCrashTestVC也成功dealloc，NSTimer也invalidate了。<br></p>
<hr>
<p>[代码链接]<br/><br>GitHub：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/jack110530/SFCrash" >https://github.com/jack110530/SFCrash</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<hr>
<p>[相关参考]<br/></p>
<ol>
<li><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.jianshu.com/p/f63395599633" >网易iOS App运行时Crash自动防护实践</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ol>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="https://jack110530.github.io">jack110530</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="https://jack110530.github.io/crash%E9%98%B2%E6%8A%A4-4-nstimer/">https://jack110530.github.io/crash%E9%98%B2%E6%8A%A4-4-nstimer/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-reward reward"><div class="reward-button">请我喝杯咖啡~</div><div class="reward-qrcode"><span class="reward-qrcode-alipay"><img class="reward-qrcode-alipay__img" src="/images/reward/alipay.jpg"><div class="reward-qrcode-alipay__text">支付宝打赏</div></span><span class="reward-qrcode-wechat"><img class="reward-qrcode-wechat__img" src="/images/reward/wechat.jpg"><div class="reward-qrcode-wechat__text">微信打赏</div></span></div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/runtimer-1-oc%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%9C%AC%E8%B4%A8/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">RunTimer(1)-OC对象的本质</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/crash%E9%98%B2%E6%8A%A4-3-kvc/"><span class="paginator-prev__text">Crash防护(3)-KVC</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">
          前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSTimer-Crash-%E7%9A%84%E4%BA%A7%E7%94%9F%E5%8E%9F%E5%9B%A0"><span class="toc-text">
          NSTimer Crash 的产生原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSTimer-Crash-%E9%98%B2%E6%8A%A4%E6%96%B9%E6%A1%88"><span class="toc-text">
          NSTimer Crash 防护方案</span></a></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/avatar.svg" alt="avatar"></div><p class="sidebar-ov-author__text">jack110530</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/jack110530/" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="https://www.jianshu.com/u/2b88d9edc419/" target="_blank" rel="noopener" data-popover="social.jianshu" data-popover-pos="up"><span class="sidebar-ov-social-item__icon">简</span></a><a class="sidebar-ov-social-item" href="https://juejin.im/user/2700056291192391/" target="_blank" rel="noopener" data-popover="social.juejin" data-popover-pos="up"><span class="sidebar-ov-social-item__icon">掘</span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">18</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">5</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">11</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2020</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>jack110530</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.2.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.3.0</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="/js/utils.js?v=2.3.0"></script><script src="/js/stun-boot.js?v=2.3.0"></script><script src="/js/scroll.js?v=2.3.0"></script><script src="/js/header.js?v=2.3.0"></script><script src="/js/sidebar.js?v=2.3.0"></script></body></html>